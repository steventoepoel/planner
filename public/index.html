<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

<!-- ‚úÖ SEO basis -->
<title>Toepoel's Reisplanner ‚Äì Normale & Extra Korte Overstappen</title>
<meta name="description" content="Snelle treinplanner met normale √©n extra korte overstappen. Bekijk minimale overstaptijd, vergelijk reistijden en check live OV-aansluitingen." />
<link rel="canonical" href="https://www.toepoels.nl/" />
<meta name="robots" content="index,follow" />

<!-- ‚úÖ Open Graph / social share -->
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Toepoel's Reisplanner" />
<meta property="og:title" content="Toepoel's Reisplanner" />
<meta property="og:description" content="Normale √©n extra korte overstappen. Bekijk minimale overstaptijd, vergelijk reistijden en check live OV-aansluitingen." />
<meta property="og:url" content="https://www.toepoels.nl/" />
<meta property="og:image" content="https://www.toepoels.nl/toepoels_planner_optimized.webp" />
<meta property="og:image:type" content="image/webp" />

<!-- ‚úÖ Twitter card -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Toepoel's Reisplanner" />
<meta name="twitter:description" content="Normale √©n extra korte overstappen. Bekijk minimale overstaptijd, vergelijk reistijden en check live OV-aansluitingen." />
<meta name="twitter:image" content="https://www.toepoels.nl/toepoels_planner_optimized.webp" />

<!-- ‚úÖ Structured data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Toepoel's Reisplanner",
  "url": "https://www.toepoels.nl/",
  "applicationCategory": "TravelApplication",
  "operatingSystem": "All",
  "description": "Snelle treinplanner met normale en extra korte overstappen, minimale overstaptijd en live OV-aansluitingen.",
  "image": "https://www.toepoels.nl/toepoels_planner_optimized.webp"
}
</script>

<!-- ‚úÖ Versie -->
<meta name="app-version" content="1.08" />

<link rel="manifest" href="/manifest.json" />
<meta name="theme-color" content="#275D63" />

<!-- Icons (PWA icons blijven PNG) -->
<link rel="icon" type="image/png" href="/logo-192.png" />
<link rel="apple-touch-icon" href="/logo-192.png" />

<style>
:root{
  --brand:#275D63;
  --brand2:#2f6f76;
  --brandText:#ffffff;

  --bg:#f4f6f6;
  --card:#ffffff;
  --text:#102022;
  --muted:#4b5a5c;
  --border:#e3e8e8;

  --good:#1f8f4a;
  --ok:#c77700;
  --bad:#c40000;

  --chip:#eef2f2;
  --fav:#ffd700;
  --favText:#111;

  --warnBg:#ffb347;
  --warnText:#1a1a1a;
}

/* ‚úÖ Volgt device theme automatisch */
@media (prefers-color-scheme: dark){
  :root{
    --bg:#0f1415;
    --card:#151c1d;
    --text:#e6f0f1;
    --muted:#9db0b3;
    --border:#2a3537;

    --good:#39c26d;
    --ok:#ffb347;
    --bad:#ff6b6b;

    --chip:#223033;
    --fav:#f0c800;
    --favText:#111;

    --warnBg:#7a5200;
    --warnText:#ffe7b0;
  }
}

*{ box-sizing:border-box; }
body{
  font-family: Arial, sans-serif;
  margin:0;
  background:var(--bg);
  color:var(--text);
  padding-bottom: max(14px, env(safe-area-inset-bottom));
}

/* Safe area */
.safe{
  padding-left: max(14px, env(safe-area-inset-left));
  padding-right:max(14px, env(safe-area-inset-right));
}

/* Header */
header{
  background:var(--brand);
  color:var(--brandText);
  padding-top: max(18px, env(safe-area-inset-top));
  padding-bottom:18px;
}
.headerRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
  max-width:1000px;
  margin:auto;
  flex-wrap:wrap;
  gap:16px;
}
.brandBlock{
  display:flex;
  align-items:center;
  gap:14px;
}
.brandBlock img{
  width:92px;
  height:92px;
  border-radius:22px;
  background:rgba(255,255,255,0.15);
  padding:10px;
  object-fit:contain;
}

/* Mode toggle (naast logo) */
.modeWrap{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.modeLabel{
  font-weight:900;
  font-size:13px;
  opacity:.95;
}
.segment{
  display:flex;
  gap:10px;
  align-items:center;
}
.segmentBtn{
  width:auto;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.35);
  background:rgba(255,255,255,0.12);
  color:#fff;
  font-weight:900;
  font-size:13px;
  cursor:pointer;
  user-select:none;
}
.segmentBtn.active{
  background:#fff;
  color:var(--brand);
  border-color:#fff;
}

.headerControls{
  display:flex;
  gap:12px;
  align-items:center;
  font-weight:900;
  opacity:0.95;
}

/* Hide right header text on mobile */
@media (max-width:768px){
  .headerControls{ display:none; }
}

/* Content */
.container{
  max-width:1000px;
  margin:auto;
  padding-top:14px;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px;
  margin-top:16px;
}

label{ font-weight:800; display:block; margin-top:8px; }
input, select, button{
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:12px;
  border:1px solid var(--border);
  font-size:16px;
  background:var(--card);
  color:var(--text);
}
button{
  background:var(--brand);
  color:white;
  border:none;
  font-weight:900;
}
button:hover{ background:var(--brand2); cursor:pointer; }
button:disabled{ opacity:0.75; cursor:not-allowed; }

.row{ display:flex; gap:12px; margin-top:10px; }
.row > *{ flex:1; }

.small{ color:var(--muted); font-size:13px; line-height:1.35; }

/* Datum/tijd layout */
.datetimeRow{
  display:flex;
  gap:12px;
  margin-top:6px;
  align-items:flex-start;
}
.datetimeRow .col{ flex:1; }
.datetimeRow .timeCols{ display:flex; gap:10px; }
.datetimeRow .timeCols select{ flex:1; }

@media (max-width:768px){
  .headerRow{ flex-direction:column; align-items:center; text-align:center; }
  .brandBlock{ flex-direction:column; align-items:center; gap:12px; }
  .brandBlock img{ width:78px; height:78px; }
  .row{ flex-direction:column; gap:10px; }
  .datetimeRow{ flex-direction:column; }
  .datetimeRow .timeCols{ width:100%; }
}

/* Result cards (clickable + expand) */
.resultCard{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
  margin-top:12px;
}
.resultHeader{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:center;
  cursor:pointer;
}
.resultHeaderLeft{
  display:flex;
  flex-direction:column;
  gap:4px;
  min-width:0;
}
.tripTitle{ font-weight:900; }
.timeBig{
  font-size:20px;
  font-weight:900;
}
.timeBig span{ font-size:22px; font-weight:900; }

.badgeRow{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:6px;
}
.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  background:var(--chip);
  font-size:12px;
  font-weight:900;
  color:var(--muted);
}
.badge.good{ color:var(--good); }
.badge.ok{ color:var(--ok); }
.badge.bad{ color:var(--bad); }

.chev{
  font-weight:900;
  font-size:18px;
  user-select:none;
}

.details{
  display:none;
  margin-top:10px;
}
.details.open{ display:block; }

.warn{
  background:var(--warnBg);
  color:var(--warnText);
  padding:8px 10px;
  border-radius:12px;
  margin-top:10px;
  font-weight:900;
}

.hr{ height:1px; background:var(--border); margin:10px 0; }

.leg{ padding:8px 0; }
.legTop{
  display:flex;
  justify-content:space-between;
  gap:10px;
  font-weight:900;
}
.legLine{
  margin-top:4px;
  color:var(--muted);
  font-size:13px;
  line-height:1.25;
}
.delay{ color:var(--bad); font-weight:900; }

.transferList{
  margin-top:8px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.transferItem{
  display:flex;
  justify-content:space-between;
  gap:10px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(0,0,0,0.02);
}
@media (prefers-color-scheme: dark){
  .transferItem{ background:rgba(255,255,255,0.04); }
}
.transferLeft{ font-weight:800; }
.transferRight{ font-weight:900; }
.transferRight.good{ color:var(--good); }
.transferRight.ok{ color:var(--ok); }
.transferRight.bad{ color:var(--bad); }

/* Favorieten */
.favBtn{ background:var(--fav); color:var(--favText); }

.favlist .favitem{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  padding:10px;
  border-radius:12px;
  border:1px solid var(--border);
  margin-top:8px;
}
.favLeft{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}
.favGrip{
  font-weight:900;
  opacity:.65;
  cursor:grab;
  user-select:none;
  padding:6px 6px;
  border-radius:10px;
  border:1px dashed var(--border);
}
.favName{
  cursor:pointer;
  font-weight:900;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width: 62vw;
}
@media (min-width: 769px){
  .favName{ max-width: 520px; }
}

.favRight{
  display:flex;
  gap:8px;
  align-items:center;
}

.favMove{
  width:auto;
  padding:8px 10px;
  border-radius:12px;
  background:var(--chip);
  border:1px solid var(--border);
  color:var(--text);
  font-weight:900;
}
.favDel{
  width:auto;
  padding:8px 12px;
  border-radius:12px;
  background:var(--chip);
  border:1px solid var(--border);
  color:var(--text);
  font-weight:900;
}

/* OV inline (arrival-only) */
.ovBtn{
  width:auto;
  padding:6px 10px;
  border-radius:12px;
  background:var(--chip);
  border:1px solid var(--border);
  color:var(--text);
  font-weight:900;
  font-size:12px;
  margin-left:8px;
}
.ovBtn:hover{ cursor:pointer; }

.ovPanel{
  margin-top:10px;
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  background:rgba(0,0,0,0.02);
}
@media (prefers-color-scheme: dark){
  .ovPanel{ background:rgba(255,255,255,0.04); }
}
.ovItem{
  display:flex;
  justify-content:space-between;
  gap:10px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid var(--border);
  margin-top:8px;
  align-items:center;
}
.ovLeft{ font-weight:900; white-space:nowrap; }
.ovMid{ color:var(--muted); font-weight:800; min-width:0; overflow:hidden; text-overflow:ellipsis; }
.ovRight{ font-weight:900; white-space:nowrap; }
.ovDelay{ color:var(--bad); font-weight:900; margin-left:6px; }

.ovTransfer{
  font-size:12px;
  font-weight:900;
  margin-left:10px;
  padding:4px 8px;
  border-radius:999px;
  background:var(--chip);
  border:1px solid var(--border);
}
.ovTransfer.good{ color:var(--good); }
.ovTransfer.ok{ color:var(--ok); }
.ovTransfer.bad{ color:var(--bad); }

/* Update banner */
.updateBanner{
  position:fixed;
  left:14px;
  right:14px;
  bottom: max(14px, env(safe-area-inset-bottom));
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.18);
  display:none;
  z-index:9999;
}
.updateBanner .top{
  display:flex;
  justify-content:space-between;
  gap:12px;
  align-items:center;
}
.updateBanner b{ font-weight:900; }
.updateBanner button{
  width:auto;
  margin-top:0;
  padding:10px 12px;
  border-radius:12px;
}

/* Footer */
.footer{
  max-width:1000px;
  margin:20px auto;
  font-size:12px;
  color:var(--muted);
  text-align:center;
}
.footer a{ color:var(--muted); font-weight:900; }
</style>
</head>

<body>
<header>
  <div class="safe">
    <div class="headerRow">
      <div class="brandBlock">
        <!-- ‚úÖ nieuw logo -->
        <img src="/toepoels_planner_optimized.webp" alt="Toepoel's Reisplanner logo">

        <!-- ‚úÖ toggle naast logo -->
        <div class="modeWrap">
          <div class="modeLabel">Modus</div>
          <div class="segment" role="group" aria-label="Kies modus">
            <button id="modeNormal" class="segmentBtn" type="button">Normale overstappen</button>
            <button id="modeExtreme" class="segmentBtn active" type="button">Extra korte overstappen</button>
          </div>
        </div>
      </div>

      <!-- desktop only -->
      <div class="headerControls" title="Standaard: Extra korte overstappen">
        ‚ö° Extra korte overstappen
      </div>
    </div>
  </div>
</header>

<div class="container safe">
  <div class="card">
    <label>Van</label>
    <input id="van" list="stationsVan" placeholder="Typ station (min. 2 letters)" autocomplete="off">
    <datalist id="stationsVan"></datalist>
    <div class="small" id="vanHint" style="margin-top:6px;"></div>

    <label>Naar</label>
    <input id="naar" list="stationsNaar" placeholder="Typ station (min. 2 letters)" autocomplete="off">
    <datalist id="stationsNaar"></datalist>
    <div class="small" id="naarHint" style="margin-top:6px;"></div>

    <label>Datum & tijd</label>
    <div class="datetimeRow">
      <div class="col">
        <input type="date" id="dateInput">
      </div>
      <div class="col timeCols">
        <select id="hourSelect" aria-label="Uur"></select>
        <select id="minuteSelect" aria-label="Minuut"></select>
      </div>
    </div>

    <!-- ‚úÖ vertrek / aankomst keuze -->
    <label>Zoek op</label>
    <select id="searchType">
      <option value="depart" selected>Vertrektijd</option>
      <option value="arrive">Aankomsttijd</option>
    </select>
    <div class="small">Bij aankomsttijd zoek je reizen die v√≥√≥r deze tijd aankomen.</div>

    <div class="row">
      <button id="wisselBtn" type="button" style="background:#6b7b7d;">‚áÑ Wissel</button>
      <button id="zoekBtn" type="button">Zoek reis</button>
    </div>

    <div class="row">
      <button id="favBtn" type="button" class="favBtn">‚≠ê Bewaar favoriet</button>
    </div>

    <div class="small" id="humanError" style="margin-top:10px;"></div>
  </div>

  <div class="card favlist">
    <b>Favoriete reizen</b>
    <div class="small" style="margin-top:6px;">Tip: sleep met ‚†ø om te sorteren. (Of gebruik ‚ñ≤‚ñº)</div>
    <div id="favorieten"></div>
  </div>

  <div id="resultaat"></div>
</div>

<!-- ‚úÖ update melding -->
<div class="updateBanner safe" id="updateBanner" role="status" aria-live="polite">
  <div class="top">
    <div>
      <b>Nieuwe versie beschikbaar</b><br>
      <span class="small">Klik om te herladen.</span>
    </div>
    <button id="reloadBtn" type="button">Herladen</button>
  </div>
</div>

<div class="footer safe">
  <div>Aan deze planner kunnen geen rechten aan worden ontleend.</div>
  <div>Deze planner helpt je alleen om te kijken of je nog sneller kunt reizen.</div>
  <div>Dit lukt niet altijd. üòâ</div>
  <div style="margin-top:6px;">
    <a href="/over.html">Uitleg / Over</a>
  </div>
  <div style="margin-top:6px;">Versie: <span id="appVersion"></span></div>
</div>

<script>
/* =========================
   VERSION + STORAGE MIGRATIE (v1.08)
   ========================= */
const APP_VERSION = document.querySelector('meta[name="app-version"]')?.content || "onbekend";
document.getElementById("appVersion").textContent = APP_VERSION;

/* storage schema */
const STORAGE_SCHEMA_KEY = "planner_storage_schema";
const STORAGE_SCHEMA_CURRENT = 2; // v2 = favorieten met id + order + uitbreidbaar

function migrateStorageIfNeeded(){
  const raw = localStorage.getItem(STORAGE_SCHEMA_KEY);
  const current = Number(raw || 0);

  if (!current){
    // v1.07: planner_favorieten_v1 = [{van,naar}]
    const oldFavKey = "planner_favorieten_v1";
    const newFavKey = "planner_favorieten_v2";

    if (!localStorage.getItem(newFavKey) && localStorage.getItem(oldFavKey)){
      try{
        const old = JSON.parse(localStorage.getItem(oldFavKey) || "[]");
        const mapped = Array.isArray(old) ? old.map((f, idx)=>({
          id: String(Date.now()) + "_" + idx,
          van: String(f?.van || "").trim(),
          naar: String(f?.naar || "").trim()
        })).filter(x=>x.van && x.naar) : [];
        localStorage.setItem(newFavKey, JSON.stringify(mapped));
      } catch {}
    }

    localStorage.setItem(STORAGE_SCHEMA_KEY, String(STORAGE_SCHEMA_CURRENT));
    return;
  }

  if (current < STORAGE_SCHEMA_CURRENT){
    localStorage.setItem(STORAGE_SCHEMA_KEY, String(STORAGE_SCHEMA_CURRENT));
  }
}
migrateStorageIfNeeded();

/* ------------ helpers ------------ */
function pad2(n){ return String(n).padStart(2,"0"); }
function roundTo5Min(d){
  const x = new Date(d);
  x.setMinutes(Math.floor(x.getMinutes()/5)*5, 0, 0);
  return x;
}
function localISODate(d){
  const x = new Date(d);
  return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;
}
function fmtTime(iso){
  if (!iso) return "‚Äî";
  const d = new Date(iso);
  if (isNaN(d.getTime())) return "‚Äî";
  return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
}
function humanizeError(err){
  const msg = String(err || "");
  if (!navigator.onLine) return "Je bent offline. Probeer later opnieuw.";
  if (msg.includes("HTTP 401") || msg.includes("HTTP 403")) return "NS API key werkt niet (toegang geweigerd).";
  if (msg.includes("HTTP 500") || msg.includes("HTTP 502") || msg.includes("HTTP 503")) return "NS API is tijdelijk niet bereikbaar.";
  if (msg.includes("AbortError")) return "";
  return msg || "Er ging iets mis. Probeer opnieuw.";
}
async function fetchJson(url, options){
  const r = await fetch(url, options);
  const ct = (r.headers.get("content-type") || "").toLowerCase();
  const text = await r.text();

  let data = null;
  if (ct.includes("application/json")){
    try { data = JSON.parse(text); } catch {}
  }
  if (!r.ok){
    const errMsg = (data && (data.error || data.message)) ? (data.error || data.message) : `HTTP ${r.status}`;
    throw new Error(errMsg);
  }
  if (!data) throw new Error("Server gaf geen JSON terug");
  return data;
}
function debounce(fn, ms=200){
  let t=null;
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}
function transferClass(min){
  if (min === null || min === undefined) return "";
  if (min < 1) return "bad";
  if (min < 3) return "ok";
  return "good";
}

/* Normalize leg */
function normLeg(l){
  const dep = l?.dep || l?.origin?.plannedDateTime || null;
  const arr = l?.arr || l?.destination?.plannedDateTime || null;

  const originName = l?.originName || l?.origin?.name || null;
  const destName   = l?.destName   || l?.destination?.name || null;

  const depTrack = l?.depTrack ?? l?.origin?.plannedTrack ?? "?";
  const arrTrack = l?.arrTrack ?? l?.destination?.plannedTrack ?? "?";

  const delayMin = l?.delayMin ?? l?.origin?.delayInMinutes ?? 0;

  const product =
    (typeof l?.product === "string" ? l.product : null) ||
    l?.product?.longCategoryName ||
    l?.product?.shortCategoryName ||
    l?.product?.categoryName ||
    "Trein";

  return { dep, arr, originName, destName, depTrack, arrTrack, delayMin, product };
}

function computeTransfersFromLegs(legs){
  const transfers = [];
  let minTransferMin = null;

  if (!Array.isArray(legs) || legs.length < 2) return { transfers, minTransferMin };

  const nlegs = legs.map(normLeg);
  for (let i=0; i<nlegs.length-1; i++){
    const a = nlegs[i];
    const b = nlegs[i+1];
    if (!a.arr || !b.dep) continue;

    const aT = Date.parse(a.arr);
    const bT = Date.parse(b.dep);
    if (!isFinite(aT) || !isFinite(bT)) continue;

    const m = Math.round((bT - aT)/60000);
    const station = a.destName || "Overstap";

    if (m < 0) continue;

    transfers.push({ station, minutes: m });
    if (minTransferMin === null || m < minTransferMin) minTransferMin = m;
  }
  return { transfers, minTransferMin };
}

function sortByStartTime(arr){
  return arr.sort((a,b)=> (+new Date(a.depart)) - (+new Date(b.depart)));
}

/* ------------ state keys ------------ */
const LS = {
  van:"last_van",
  naar:"last_naar",
  mode:"planner_mode",            // "extreme" | "normal"
  searchType:"planner_searchType" // "depart" | "arrive"
};

/* ------------ elements ------------ */
const vanInput = document.getElementById("van");
const naarInput = document.getElementById("naar");
const stationsVan = document.getElementById("stationsVan");
const stationsNaar = document.getElementById("stationsNaar");
const dateInput = document.getElementById("dateInput");
const hourSelect = document.getElementById("hourSelect");
const minuteSelect = document.getElementById("minuteSelect");
const wisselBtn = document.getElementById("wisselBtn");
const zoekBtn = document.getElementById("zoekBtn");
const favBtn = document.getElementById("favBtn");
const favDiv = document.getElementById("favorieten");
const resultaat = document.getElementById("resultaat");
const humanErrorEl = document.getElementById("humanError");
const vanHint = document.getElementById("vanHint");
const naarHint = document.getElementById("naarHint");
const searchTypeEl = document.getElementById("searchType");
const modeNormalBtn = document.getElementById("modeNormal");
const modeExtremeBtn = document.getElementById("modeExtreme");

/* ‚úÖ keyboard weg als je ergens tikt (mobile) */
function dismissKeyboard(){ document.activeElement?.blur?.(); }
document.addEventListener("touchstart", (e) => {
  const t = e.target;
  if (t && (t.tagName === "INPUT" || t.tagName === "SELECT" || t.tagName === "TEXTAREA" || t.closest?.("button"))) return;
  dismissKeyboard();
}, { passive:true });
document.addEventListener("click", (e) => {
  const t = e.target;
  if (t && (t.tagName === "INPUT" || t.tagName === "SELECT" || t.tagName === "TEXTAREA" || t.closest?.("button"))) return;
  dismissKeyboard();
});

/* date fully clickable */
dateInput.addEventListener("click", ()=>{
  if (dateInput.showPicker) dateInput.showPicker();
  else dateInput.focus();
});

/* fill time selects */
for(let h=0; h<24; h++){
  const o=document.createElement("option");
  o.value=pad2(h); o.textContent=pad2(h);
  hourSelect.appendChild(o);
}
for(let m=0; m<60; m+=5){
  const o=document.createElement("option");
  o.value=pad2(m); o.textContent=pad2(m);
  minuteSelect.appendChild(o);
}

/* load saved inputs */
vanInput.value = localStorage.getItem(LS.van) || "";
naarInput.value = localStorage.getItem(LS.naar) || "";

/* ‚úÖ Datum/tijd bij start altijd NU */
const now = roundTo5Min(new Date());
dateInput.value = localISODate(now);
hourSelect.value = pad2(now.getHours());
minuteSelect.value = pad2(now.getMinutes());

/* search type restore */
searchTypeEl.value = localStorage.getItem(LS.searchType) || "depart";
searchTypeEl.addEventListener("change", ()=> localStorage.setItem(LS.searchType, searchTypeEl.value));

function persistStations(){
  localStorage.setItem(LS.van, vanInput.value);
  localStorage.setItem(LS.naar, naarInput.value);
}
["input","change"].forEach(evt=>{
  vanInput.addEventListener(evt, persistStations);
  naarInput.addEventListener(evt, persistStations);
});

/* click-to-clear stations */
function clearOnClick(el, key){
  el.addEventListener("click", ()=>{
    if (el.value.trim()) {
      el.value = "";
      localStorage.setItem(key,"");
    }
  });
}
clearOnClick(vanInput, LS.van);
clearOnClick(naarInput, LS.naar);

/* ------------ MODE (standaard extreme) ------------ */
function setMode(mode){
  const m = (mode === "normal") ? "normal" : "extreme";
  localStorage.setItem(LS.mode, m);

  modeNormalBtn.classList.toggle("active", m === "normal");
  modeExtremeBtn.classList.toggle("active", m === "extreme");

  const hc = document.querySelector(".headerControls");
  if (hc) hc.textContent = (m === "extreme") ? "‚ö° Extra korte overstappen" : "‚úÖ Normale overstappen";
}
setMode(localStorage.getItem(LS.mode) || "extreme");
modeNormalBtn.addEventListener("click", ()=> setMode("normal"));
modeExtremeBtn.addEventListener("click", ()=> setMode("extreme"));

/* ------------ autocomplete (sneller) ------------ */
let vanList = [];
let naarList = [];

const stationCache = new Map();
let stationAbortVan = null;
let stationAbortNaar = null;

function normName(x){ return (x||"").trim().toLowerCase(); }

function setHint(which, text){
  if (which === "van") vanHint.textContent = text || "";
  if (which === "naar") naarHint.textContent = text || "";
}

async function loadStations(q, listEl, store, which){
  const query = (q || "").trim();
  if (query.length < 2) {
    listEl.innerHTML = "";
    store.length = 0;
    setHint(which, query.length ? "Typ minimaal 2 letters voor suggesties." : "");
    return;
  }

  setHint(which, "");

  const key = (which + ":" + query.toLowerCase());
  if (stationCache.has(key)){
    const data = stationCache.get(key) || [];
    listEl.innerHTML = "";
    store.length = 0;
    data.forEach(s=>{
      const opt=document.createElement("option");
      opt.value = s.namen.lang;
      listEl.appendChild(opt);
      store.push(s);
    });
    return;
  }

  if (which === "van"){
    if (stationAbortVan) stationAbortVan.abort();
    stationAbortVan = new AbortController();
  } else {
    if (stationAbortNaar) stationAbortNaar.abort();
    stationAbortNaar = new AbortController();
  }
  const signal = (which === "van") ? stationAbortVan.signal : stationAbortNaar.signal;

  const data = await fetchJson(`/stations?q=${encodeURIComponent(query)}`, { signal });
  stationCache.set(key, data || []);

  listEl.innerHTML = "";
  store.length = 0;
  (data||[]).forEach(s=>{
    const opt=document.createElement("option");
    opt.value = s.namen.lang;
    listEl.appendChild(opt);
    store.push(s);
  });

  if (!store.length){
    setHint(which, "Geen stations gevonden. Controleer spelling.");
  }
}

vanInput.addEventListener("input", debounce(()=>loadStations(vanInput.value, stationsVan, vanList, "van"), 200));
naarInput.addEventListener("input", debounce(()=>loadStations(naarInput.value, stationsNaar, naarList, "naar"), 200));

async function resolveCode(name, store, which){
  const wanted = normName(name);

  const hit = store.find(s=> normName(s.namen.lang) === wanted);
  if (hit) return hit.code;

  for (const arr of stationCache.values()){
    const ex = (arr||[]).find(s=> normName(s.namen.lang) === wanted);
    if (ex) return ex.code;
  }

  if (String(name||"").trim().length < 2){
    setHint(which, "Typ minimaal 2 letters en kies een suggestie.");
    return null;
  }

  const data = await fetchJson(`/stations?q=${encodeURIComponent(name)}`);
  const exact = (data||[]).find(s=> normName(s.namen.lang) === wanted);

  if (!exact){
    setHint(which, "Kies een station uit de lijst (klik op een suggestie).");
    return null;
  }
  return exact.code;
}

function validateStationInput(el, store, which){
  const val = el.value.trim();
  if (!val) { setHint(which, ""); return; }
  const wanted = normName(val);
  const exactInStore = store.some(s=> normName(s.namen.lang) === wanted);
  if (!exactInStore){
    setHint(which, "Kies een station uit de lijst (klik op een suggestie).");
  } else {
    setHint(which, "");
  }
}
vanInput.addEventListener("blur", ()=>validateStationInput(vanInput, vanList, "van"));
naarInput.addEventListener("blur", ()=>validateStationInput(naarInput, naarList, "naar"));

function buildDateTime(){
  return `${dateInput.value}T${hourSelect.value}:${minuteSelect.value}`;
}

/* =========================
   OV helpers (arrival-only)
   ========================= */
const OV_CODE_BY_NAME = new Map([
  ["dordrecht", "ddr"],
  ["dordrecht zuid", "ddzd"],
  ["rotterdam blaak", "rtb"],
  ["rotterdam centraal", "rtd"],
  ["den haag hs", "gvh"],
  ["den haag centraal", "gvc"]
]);

function fmtHHMM(iso){
  const d = new Date(iso);
  if (isNaN(d.getTime())) return "‚Äî";
  return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
}

function classifyOvTransfer(min){
  if (!Number.isFinite(min)) return "";
  if (min < 3) return "bad";
  if (min < 6) return "ok";
  return "good";
}

function ovIcon(type){
  const t = String(type || "").toUpperCase();
  if (t.includes("METRO")) return "üöá";
  if (t.includes("TRAM")) return "üöã";
  return "üöå";
}

/* Render OV list with transfer time; hide negative + max 30 min */
function renderOvPanel(panelEl, title, ovData, trainArrIso){
  panelEl.innerHTML = "";

  const head = document.createElement("div");
  head.style.fontWeight = "900";
  head.textContent = title;
  panelEl.appendChild(head);

  const trainArrT = Date.parse(trainArrIso || "");
  const deps = Array.isArray(ovData?.departures) ? ovData.departures : [];

  let shown = 0;

  deps.slice(0, 30).forEach(d => {
    const depIso = d.expectedTime || d.plannedTime;
    const depT = Date.parse(depIso || "");
    if (!isFinite(depT) || !isFinite(trainArrT)) return;

    const transferMin = Math.round((depT - trainArrT) / 60000);

    if (transferMin < 0) return;
    if (transferMin > 30) return;

    shown++;

    const row = document.createElement("div");
    row.className = "ovItem";

    const left = document.createElement("div");
    left.className = "ovLeft";
    left.textContent = `${ovIcon(d.transportType)} ${d.line || ""}`.trim();

    const mid = document.createElement("div");
    mid.className = "ovMid";
    mid.textContent = d.destination || d.stopName || "";

    const right = document.createElement("div");
    right.className = "ovRight";
    right.textContent = fmtHHMM(depIso);

    const badge = document.createElement("span");
    badge.className = `ovTransfer ${classifyOvTransfer(transferMin)}`;
    badge.textContent = `overstap ${transferMin} min`;

    row.appendChild(left);
    row.appendChild(mid);
    row.appendChild(right);
    row.appendChild(badge);

    panelEl.appendChild(row);
  });

  if (shown === 0){
    const msg = document.createElement("div");
    msg.className = "small";
    msg.style.marginTop = "6px";
    msg.textContent = "Geen haalbare OV-vertrektijden binnen 30 minuten na aankomst van de trein.";
    panelEl.appendChild(msg);
  }

  const foot = document.createElement("div");
  foot.className = "small";
  foot.style.marginTop = "8px";
  foot.innerHTML = `Trein aankomst: <b>${fmtTime(trainArrIso)}</b><br>OV filter: 0‚Äì30 min`;
  panelEl.appendChild(foot);
}

async function loadOv(panelEl, stationCode, title, trainArrIso){
  panelEl.innerHTML = `<div class="small">Laden‚Ä¶</div>`;
  try{
    const data = await fetchJson(`/ov/by-station?station=${encodeURIComponent(stationCode)}`);
    renderOvPanel(panelEl, title, data, trainArrIso);
  } catch(e){
    panelEl.innerHTML = `<div class="small">${humanizeError(e)}</div>`;
  }
}

/* Render expandable trip card (lazy details) */
function renderExpandableTrip(opt){
  const card = document.createElement("div");
  card.className = "resultCard";

  const depart = opt.depart;
  const arrive = opt.arrive;
  const durationMin = opt.durationMin;
  const legs = opt.legs || [];
  const transfersCount = Math.max(0, legs.length - 1);

  const transfersInfo = opt.transfersInfo || computeTransfersFromLegs(legs);
  const transfers = transfersInfo.transfers || [];
  const minTransferMin = transfersInfo.minTransferMin ?? null;
  const minCls = transferClass(minTransferMin);

  const header = document.createElement("div");
  header.className = "resultHeader";
  header.innerHTML = `
    <div class="resultHeaderLeft">
      <div class="tripTitle">Totale reistijd: ${durationMin} min</div>
      <div class="timeBig"><span>${fmtTime(depart)}</span> ‚Üí <span>${fmtTime(arrive)}</span></div>
      <div class="badgeRow">
        <span class="badge">Overstappen: ${transfersCount}</span>
        ${minTransferMin !== null ? `<span class="badge ${minCls}">Min overstap: ${minTransferMin} min</span>` : ""}
      </div>
    </div>
    <div class="chev">‚ñæ</div>
  `;

  const details = document.createElement("div");
  details.className = "details";

  let built = false;
  function buildDetails(){
    if (built) return;
    built = true;

    if (minTransferMin !== null && minTransferMin < 3) {
      const w = document.createElement("div");
      w.className = "warn";
      w.textContent = `‚ö†Ô∏è Korte overstaptijd: minimaal ${minTransferMin} minuten.`;
      details.appendChild(w);
    }

    if (transfers.length){
      const tl = document.createElement("div");
      tl.className = "transferList";
      tl.innerHTML = `<b>Overstappen</b>`;
      transfers.forEach(t=>{
        const item = document.createElement("div");
        item.className = "transferItem";
        item.innerHTML = `
          <div class="transferLeft">${t.station}</div>
          <div class="transferRight ${transferClass(t.minutes)}">${t.minutes} min</div>
        `;
        tl.appendChild(item);
      });
      details.appendChild(tl);
    }

    const hr = document.createElement("div");
    hr.className = "hr";
    details.appendChild(hr);

    let openPanel = null;

    legs.forEach((l, idx)=>{
      const x = normLeg(l);

      const destNameNorm = normName(x.destName || "");
      const ovCode = OV_CODE_BY_NAME.get(destNameNorm) || null;
      const showOv = Boolean(ovCode && x.arr);

      const legEl = document.createElement("div");
      legEl.className = "leg";

      const legTop = document.createElement("div");
      legTop.className = "legTop";
      legTop.innerHTML = `
        <div>üöÜ ${x.product}</div>
        <div>${fmtTime(x.dep)} ‚Üí ${fmtTime(x.arr)}</div>
      `;

      const legLine = document.createElement("div");
      legLine.className = "legLine";
      legLine.innerHTML = `
        ${x.originName || "‚Äî"} (spoor ${x.depTrack ?? "?"}) ‚Üí ${x.destName || "‚Äî"} (spoor ${x.arrTrack ?? "?"})
        ${x.delayMin > 0 ? `<span class="delay"> +${x.delayMin} min</span>` : ""}
      `;

      if (showOv){
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "ovBtn";
        btn.textContent = "OV";
        legLine.appendChild(btn);

        const panel = document.createElement("div");
        panel.className = "ovPanel";
        panel.style.display = "none";
        legEl.appendChild(panel);

        btn.addEventListener("click", async (e)=>{
          e.stopPropagation();

          if (openPanel && openPanel !== panel){
            openPanel.style.display = "none";
            openPanel.innerHTML = "";
          }

          const isOpen = panel.style.display !== "none";
          if (isOpen){
            panel.style.display = "none";
            panel.innerHTML = "";
            openPanel = null;
            return;
          }

          panel.style.display = "block";
          openPanel = panel;

          await loadOv(panel, ovCode, `Live OV bij ${x.destName}`, x.arr);
        });
      }

      legEl.appendChild(legTop);
      legEl.appendChild(legLine);
      details.appendChild(legEl);

      if (idx < legs.length - 1) {
        const hr2 = document.createElement("div");
        hr2.className = "hr";
        details.appendChild(hr2);
      }
    });
  }

  header.addEventListener("click", ()=>{
    const willOpen = !details.classList.contains("open");
    if (willOpen) buildDetails();
    const isOpen = details.classList.toggle("open");
    header.querySelector(".chev").textContent = isOpen ? "‚ñ¥" : "‚ñæ";
  });

  card.appendChild(header);
  card.appendChild(details);
  return card;
}

/* =========================
   SEARCH (Normal / Extreme + vertrek/aankomst)
   ========================= */
const EXTREME_ENDPOINT = "/reis-extreme-b";
const NORMAL_ENDPOINT  = "/reis";

let inFlightSearch = null;

function getMode(){
  return localStorage.getItem(LS.mode) === "normal" ? "normal" : "extreme";
}

async function zoekReis(){
  humanErrorEl.textContent = "";
  resultaat.innerHTML = "";

  if (vanInput.value.trim().toLowerCase() === naarInput.value.trim().toLowerCase()) {
    humanErrorEl.textContent = "‚ö†Ô∏è Je hebt hetzelfde station gekozen bij vertrek en aankomst.";
    return;
  }

  if (inFlightSearch) inFlightSearch.abort();
  inFlightSearch = new AbortController();
  const signal = inFlightSearch.signal;

  try{
    const vanName = vanInput.value.trim();
    const naarName = naarInput.value.trim();
    const dt = buildDateTime();
    const searchType = searchTypeEl.value;
    const searchForArrival = (searchType === "arrive");

    if (!vanName || !naarName) { humanErrorEl.textContent = "Vul van en naar in."; return; }
    if (!dt) { humanErrorEl.textContent = "Kies datum/tijd."; return; }

    zoekBtn.disabled = true;
    zoekBtn.textContent = "Zoeken‚Ä¶";

    const [vanCode, naarCode] = await Promise.all([
      resolveCode(vanName, vanList, "van"),
      resolveCode(naarName, naarList, "naar")
    ]);

    if (!vanCode || !naarCode) {
      humanErrorEl.textContent = "‚ö†Ô∏è Kies stations uit de lijst (klik op een suggestie).";
      return;
    }

    const endpoint = (getMode() === "normal") ? NORMAL_ENDPOINT : EXTREME_ENDPOINT;

    const url =
      `${endpoint}?van=${encodeURIComponent(vanCode)}&naar=${encodeURIComponent(naarCode)}&datetime=${encodeURIComponent(dt)}&searchForArrival=${encodeURIComponent(String(searchForArrival))}`;

    const data = await fetchJson(url, { signal });
    const opts = Array.isArray(data.options) ? data.options : [];

    if (!opts.length) {
      resultaat.innerHTML = `<div class="resultCard">Geen opties gevonden.</div>`;
      return;
    }

    opts.forEach(o=>{
      o.transfersInfo = o.transfersInfo || computeTransfersFromLegs(o.legs || []);
    });

    const frag = document.createDocumentFragment();
    sortByStartTime(opts).forEach(o=>{
      frag.appendChild(renderExpandableTrip(o));
    });
    resultaat.appendChild(frag);

  } catch(e){
    const msg = humanizeError(e);
    if (msg) {
      humanErrorEl.textContent = msg;
      resultaat.innerHTML = `<div class="resultCard">${msg}</div>`;
    }
  } finally{
    zoekBtn.disabled = false;
    zoekBtn.textContent = "Zoek reis";
  }
}

/* Enter = zoeken */
[vanInput, naarInput, dateInput, hourSelect, minuteSelect, searchTypeEl].forEach(el=>{
  el.addEventListener("keydown",(e)=>{
    if (e.key==="Enter"){ e.preventDefault(); zoekReis(); }
  });
});
zoekBtn.addEventListener("click", zoekReis);

/* Wissel */
wisselBtn.addEventListener("click", ()=>{
  const t = vanInput.value;
  vanInput.value = naarInput.value;
  naarInput.value = t;
  persistStations();
});

/* =========================
   FAVORIETEN (LOCALSTORAGE v2) + SLEPEN/SORTEREN
   ========================= */
const FAV_KEY = "planner_favorieten_v2";

function getFavs() {
  try {
    const raw = localStorage.getItem(FAV_KEY);
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? parsed : [];
  } catch {
    return [];
  }
}
function saveFavs(favs) {
  localStorage.setItem(FAV_KEY, JSON.stringify(favs));
}
function moveItem(arr, from, to){
  const a = arr.slice();
  const [x] = a.splice(from, 1);
  a.splice(to, 0, x);
  return a;
}

let dragIndex = null;

function laadFavorieten() {
  const favs = getFavs();
  favDiv.innerHTML = "";

  if (!favs.length) {
    favDiv.innerHTML = `<div class="small">Nog geen favoriete reizen.</div>`;
    return;
  }

  const frag = document.createDocumentFragment();

  favs.forEach((f, i) => {
    const row = document.createElement("div");
    row.className = "favitem";
    row.draggable = true;
    row.dataset.index = String(i);

    row.addEventListener("dragstart", (e)=>{
      dragIndex = i;
      try { e.dataTransfer.setData("text/plain", String(i)); } catch {}
      e.dataTransfer.effectAllowed = "move";
    });
    row.addEventListener("dragover", (e)=>{
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";
    });
    row.addEventListener("drop", (e)=>{
      e.preventDefault();
      const from = (dragIndex !== null) ? dragIndex : Number(e.dataTransfer.getData("text/plain"));
      const to = i;
      if (!Number.isFinite(from) || from === to) return;

      const updated = moveItem(getFavs(), from, to);
      saveFavs(updated);
      laadFavorieten();
    });

    const left = document.createElement("div");
    left.className = "favLeft";

    const grip = document.createElement("div");
    grip.className = "favGrip";
    grip.title = "Sleep om te sorteren";
    grip.textContent = "‚†ø";

    const name = document.createElement("div");
    name.className = "favName";
    name.textContent = `${f.van} ‚Üí ${f.naar}`;
    name.onclick = () => {
      vanInput.value = f.van;
      naarInput.value = f.naar;
      persistStations();
      dismissKeyboard();
      window.scrollTo({ top: 0, behavior: "smooth" });
    };

    left.appendChild(grip);
    left.appendChild(name);

    const right = document.createElement("div");
    right.className = "favRight";

    const up = document.createElement("button");
    up.className = "favMove";
    up.type = "button";
    up.textContent = "‚ñ≤";
    up.title = "Omhoog";
    up.disabled = (i === 0);
    up.onclick = ()=>{
      const updated = moveItem(getFavs(), i, i-1);
      saveFavs(updated);
      laadFavorieten();
    };

    const down = document.createElement("button");
    down.className = "favMove";
    down.type = "button";
    down.textContent = "‚ñº";
    down.title = "Omlaag";
    down.disabled = (i === favs.length - 1);
    down.onclick = ()=>{
      const updated = moveItem(getFavs(), i, i+1);
      saveFavs(updated);
      laadFavorieten();
    };

    const del = document.createElement("button");
    del.className = "favDel";
    del.type = "button";
    del.textContent = "‚úñ";
    del.onclick = () => {
      const updated = getFavs();
      updated.splice(i, 1);
      saveFavs(updated);
      laadFavorieten();
    };

    right.appendChild(up);
    right.appendChild(down);
    right.appendChild(del);

    row.appendChild(left);
    row.appendChild(right);

    frag.appendChild(row);
  });

  favDiv.appendChild(frag);
}

favBtn.addEventListener("click", () => {
  const van = vanInput.value.trim();
  const naar = naarInput.value.trim();
  if (!van || !naar) { alert("Vul van en naar in."); return; }

  const favs = getFavs();
  const exists = favs.some(f =>
    String(f.van).toLowerCase() === van.toLowerCase() &&
    String(f.naar).toLowerCase() === naar.toLowerCase()
  );
  if (exists) { alert("Deze favoriete reis bestaat al."); return; }

  favs.push({ id: String(Date.now()), van, naar });
  saveFavs(favs);
  laadFavorieten();

  const old = favBtn.textContent;
  favBtn.textContent = "‚úÖ Opgeslagen";
  setTimeout(()=>{ favBtn.textContent = old; }, 900);
});

laadFavorieten();

/* =========================
   PWA: update-melding + herladen
   ========================= */
const updateBanner = document.getElementById("updateBanner");
const reloadBtn = document.getElementById("reloadBtn");

let swReg = null;

function showUpdateBanner(){ updateBanner.style.display = "block"; }
function hideUpdateBanner(){ updateBanner.style.display = "none"; }

reloadBtn.addEventListener("click", async ()=>{
  if (swReg?.waiting){
    try{ swReg.waiting.postMessage({ type: "SKIP_WAITING" }); } catch {}
  } else {
    location.reload();
  }
});

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sw.js").then((reg)=>{
    swReg = reg;

    if (reg.waiting) showUpdateBanner();

    reg.addEventListener("updatefound", ()=>{
      const newWorker = reg.installing;
      if (!newWorker) return;

      newWorker.addEventListener("statechange", ()=>{
        if (newWorker.state === "installed" && navigator.serviceWorker.controller){
          showUpdateBanner();
        }
      });
    });

  }).catch(()=>{});

  navigator.serviceWorker.addEventListener("controllerchange", ()=>{
    hideUpdateBanner();
    location.reload();
  });
}
</script>

<!--
‚úÖ sw.js moet dit ondersteunen:

self.addEventListener('message', (event) => {
  if (event.data && event.data.type === 'SKIP_WAITING') self.skipWaiting();
});
self.addEventListener('activate', (event) => {
  event.waitUntil(self.clients.claim());
});
-->
</body>
</html>