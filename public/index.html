<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Toepoel's</title>

<meta name="app-version" content="1.07" />

<link rel="manifest" href="/manifest.json" />
<meta name="theme-color" content="#275D63" />
<link rel="icon" type="image/png" href="/logo-192.png" />
<link rel="apple-touch-icon" href="/logo-192.png" />

<style>
:root{
  --brand:#275D63;
  --brand2:#2f6f76;
  --brandText:#ffffff;

  --bg:#f4f6f6;
  --card:#ffffff;
  --text:#102022;
  --muted:#4b5a5c;
  --border:#e3e8e8;

  --good:#1f8f4a;
  --ok:#c77700;
  --bad:#c40000;

  --chip:#eef2f2;
  --fav:#ffd700;
  --favText:#111;

  --warnBg:#ffb347;
  --warnText:#1a1a1a;
}

@media (prefers-color-scheme: dark){
  :root{
    --bg:#0f1415;
    --card:#151c1d;
    --text:#e6f0f1;
    --muted:#9db0b3;
    --border:#2a3537;

    --good:#39c26d;
    --ok:#ffb347;
    --bad:#ff6b6b;

    --chip:#223033;
    --fav:#f0c800;
    --favText:#111;

    --warnBg:#7a5200;
    --warnText:#ffe7b0;
  }
}

*{ box-sizing:border-box; }
body{
  font-family: Arial, sans-serif;
  margin:0;
  background:var(--bg);
  color:var(--text);
  padding-bottom: max(14px, env(safe-area-inset-bottom));
}

.safe{
  padding-left: max(14px, env(safe-area-inset-left));
  padding-right:max(14px, env(safe-area-inset-right));
}

header{
  background:var(--brand);
  color:var(--brandText);
  padding-top: max(18px, env(safe-area-inset-top));
  padding-bottom:18px;
}
.headerRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
  max-width:1000px;
  margin:auto;
  flex-wrap:wrap;
  gap:20px;
}
.brandBlock{
  display:flex;
  align-items:center;
  gap:18px;
}
.brandBlock img{
  width:92px;
  height:92px;
  border-radius:22px;
  background:rgba(255,255,255,0.15);
  padding:10px;
}
.tagline{
  font-weight:900;
  font-size:26px;
  line-height:1.15;
}
.tagline u{ text-decoration-thickness:3px; text-underline-offset:4px; }

.headerControls{
  display:flex;
  gap:14px;
  align-items:center;
  font-weight:900;
  opacity:0.95;
}

@media (max-width:768px){
  .headerControls{ display:none; }
}

.container{
  max-width:1000px;
  margin:auto;
  padding-top:14px;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px;
  margin-top:16px;
}

label{ font-weight:800; display:block; margin-top:8px; }
input, select, button{
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:12px;
  border:1px solid var(--border);
  font-size:16px;
  background:var(--card);
  color:var(--text);
}
button{
  background:var(--brand);
  color:white;
  border:none;
  font-weight:900;
}
button:hover{ background:var(--brand2); cursor:pointer; }
button:disabled{ opacity:0.75; cursor:not-allowed; }

.row{ display:flex; gap:12px; margin-top:10px; }
.row > *{ flex:1; }

.small{ color:var(--muted); font-size:13px; line-height:1.35; }

.datetimeRow{
  display:flex;
  gap:12px;
  margin-top:6px;
  align-items:flex-start;
}
.datetimeRow .col{ flex:1; }
.datetimeRow .timeCols{ display:flex; gap:10px; }
.datetimeRow .timeCols select{ flex:1; }

@media (max-width:768px){
  .headerRow{ flex-direction:column; align-items:center; text-align:center; }
  .brandBlock{ flex-direction:column; align-items:center; gap:12px; }
  .brandBlock img{ width:78px; height:78px; }
  .tagline{ font-size:18px; }
  .row{ flex-direction:column; gap:10px; }
  .datetimeRow{ flex-direction:column; }
  .datetimeRow .timeCols{ width:100%; }
}

.resultCard{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
  margin-top:12px;
}
.resultHeader{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:center;
  cursor:pointer;
}
.resultHeaderLeft{
  display:flex;
  flex-direction:column;
  gap:4px;
  min-width:0;
}
.tripTitle{ font-weight:900; }
.timeBig{
  font-size:20px;
  font-weight:900;
}
.timeBig span{ font-size:22px; font-weight:900; }

.badgeRow{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:6px;
}
.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  background:var(--chip);
  font-size:12px;
  font-weight:900;
  color:var(--muted);
}
.badge.good{ color:var(--good); }
.badge.ok{ color:var(--ok); }
.badge.bad{ color:var(--bad); }

.chev{
  font-weight:900;
  font-size:18px;
  user-select:none;
}

.details{
  display:none;
  margin-top:10px;
}
.details.open{ display:block; }

.warn{
  background:var(--warnBg);
  color:var(--warnText);
  padding:8px 10px;
  border-radius:12px;
  margin-top:10px;
  font-weight:900;
}

.hr{ height:1px; background:var(--border); margin:10px 0; }

.leg{ padding:8px 0; }
.legTop{
  display:flex;
  justify-content:space-between;
  gap:10px;
  font-weight:900;
}
.legLine{
  margin-top:4px;
  color:var(--muted);
  font-size:13px;
  line-height:1.25;
}
.delay{ color:var(--bad); font-weight:900; }

.transferList{
  margin-top:8px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.transferItem{
  display:flex;
  justify-content:space-between;
  gap:10px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(0,0,0,0.02);
}
@media (prefers-color-scheme: dark){
  .transferItem{ background:rgba(255,255,255,0.04); }
}
.transferLeft{ font-weight:800; }
.transferRight{ font-weight:900; }
.transferRight.good{ color:var(--good); }
.transferRight.ok{ color:var(--ok); }
.transferRight.bad{ color:var(--bad); }

/* Favorieten */
.favBtn{ background:var(--fav); color:var(--favText); }
.favlist .favitem{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  padding:10px;
  border-radius:12px;
  border:1px solid var(--border);
  margin-top:8px;
}
.favlist .favitem span{ cursor:pointer; font-weight:900; }
.favDel{
  width:auto;
  padding:8px 12px;
  border-radius:12px;
  background:var(--chip);
  border:1px solid var(--border);
  color:var(--text);
  font-weight:900;
}

/* Inline OV button */
.ovInlineBtn{
  width:auto;
  padding:6px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:var(--chip);
  color:var(--text);
  font-weight:900;
  font-size:12px;
  margin-left:8px;
  cursor:pointer;
}

/* Inline OV panel (onder de regel) */
.ovPanel{
  margin-top:10px;
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  background:rgba(0,0,0,0.02);
}
@media (prefers-color-scheme: dark){
  .ovPanel{ background:rgba(255,255,255,0.04); }
}
.ovItem{
  display:flex;
  justify-content:space-between;
  gap:10px;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  margin-top:8px;
}
.ovLeft{ font-weight:900; white-space:nowrap; }
.ovMid{ color:var(--muted); font-weight:800; min-width:0; overflow:hidden; text-overflow:ellipsis; }
.ovRight{ font-weight:900; white-space:nowrap; }
.ovDelay{ color:var(--bad); font-weight:900; margin-left:6px; }

.footer{
  max-width:1000px;
  margin:20px auto;
  font-size:12px;
  color:var(--muted);
  text-align:center;
}
</style>
</head>

<body>
<header>
  <div class="safe">
    <div class="headerRow">
      <div class="brandBlock">
        <img src="/logo-192.png" alt="Logo">
        <div class="tagline">D√© reisplanner met <u>alle</u> overstappen!</div>
      </div>
      <div class="headerControls" title="Altijd Extreem-B ingeschakeld">
        ‚ö° Altijd Extreem
      </div>
    </div>
  </div>
</header>

<div class="container safe">
  <div class="card">
    <label>Van</label>
    <input id="van" list="stationsVan" placeholder="Typ station (kies uit lijst)" autocomplete="off">
    <datalist id="stationsVan"></datalist>

    <label>Naar</label>
    <input id="naar" list="stationsNaar" placeholder="Typ station (kies uit lijst)" autocomplete="off">
    <datalist id="stationsNaar"></datalist>

    <label>Datum & tijd</label>
    <div class="datetimeRow">
      <div class="col">
        <input type="date" id="dateInput">
      </div>
      <div class="col timeCols">
        <select id="hourSelect" aria-label="Uur"></select>
        <select id="minuteSelect" aria-label="Minuut"></select>
      </div>
    </div>

    <div class="row">
      <button id="wisselBtn" type="button" style="background:#6b7b7d;">‚áÑ Wissel</button>
      <button id="zoekBtn" type="button">Zoek reis</button>
    </div>

    <div class="row">
      <button id="favBtn" type="button" class="favBtn">‚≠ê Bewaar favoriet</button>
    </div>

    <div class="small" id="humanError" style="margin-top:10px;"></div>
  </div>

  <div class="card favlist">
    <b>Favoriete reizen</b>
    <div id="favorieten"></div>
  </div>

  <div id="resultaat"></div>
</div>

<div class="footer safe">
  <div>Aan deze planner kunnen geen rechten aan worden ontleend.</div>
  <div>Deze planner helpt je alleen om te kijken of je nog sneller kunt reizen.</div>
  <div>Dit lukt niet altijd. üòâ</div>
  <div>Versie: <span id="appVersion"></span></div>
</div>

<script>
/* VERSION */
const APP_VERSION = document.querySelector('meta[name="app-version"]')?.content || "onbekend";
document.getElementById("appVersion").textContent = APP_VERSION;

/* helpers */
function pad2(n){ return String(n).padStart(2,"0"); }
function roundTo5Min(d){
  const x = new Date(d);
  x.setMinutes(Math.floor(x.getMinutes()/5)*5, 0, 0);
  return x;
}
function localISODate(d){
  const x = new Date(d);
  return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;
}
function fmtTime(iso){
  if (!iso) return "‚Äî";
  const d = new Date(iso);
  if (isNaN(d.getTime())) return "‚Äî";
  return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
}
function humanizeError(err){
  const msg = String(err || "");
  if (msg.includes("Vertrek- en aankomststation mogen niet hetzelfde zijn"))
    return "‚ö†Ô∏è Je hebt hetzelfde station gekozen bij vertrek en aankomst.";
  if (!navigator.onLine) return "Je bent offline. Probeer later opnieuw.";
  if (msg.includes("HTTP 401") || msg.includes("HTTP 403")) return "NS API key werkt niet (toegang geweigerd).";
  if (msg.includes("HTTP 500") || msg.includes("HTTP 502") || msg.includes("HTTP 503")) return "NS API is tijdelijk niet bereikbaar.";
  if (msg.includes("AbortError")) return "";
  return msg || "Er ging iets mis. Probeer opnieuw.";
}
async function fetchJson(url, options){
  const r = await fetch(url, options);
  const ct = (r.headers.get("content-type") || "").toLowerCase();
  const text = await r.text();

  let data = null;
  if (ct.includes("application/json")){
    try { data = JSON.parse(text); } catch {}
  }
  if (!r.ok){
    const errMsg = (data && (data.error || data.message)) ? (data.error || data.message) : `HTTP ${r.status}`;
    throw new Error(errMsg);
  }
  if (!data) throw new Error("Server gaf geen JSON terug");
  return data;
}
function debounce(fn, ms=200){
  let t=null;
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}
function transferClass(min){
  if (min === null || min === undefined) return "";
  if (min < 1) return "bad";
  if (min < 3) return "ok";
  return "good";
}
function normName(x){ return (x||"").trim().toLowerCase(); }

/* Normalize leg */
function normLeg(l){
  const dep = l?.dep || l?.origin?.plannedDateTime || null;
  const arr = l?.arr || l?.destination?.plannedDateTime || null;

  const originName = l?.originName || l?.origin?.name || null;
  const destName   = l?.destName   || l?.destination?.name || null;

  const originCode = l?.originCode || l?.origin?.stationCode || l?.origin?.code || null;
  const destCode   = l?.destCode   || l?.destination?.stationCode || l?.destination?.code || null;

  const depTrack = l?.depTrack ?? l?.origin?.plannedTrack ?? "?";
  const arrTrack = l?.arrTrack ?? l?.destination?.plannedTrack ?? "?";

  const delayMin = l?.delayMin ?? l?.origin?.delayInMinutes ?? 0;

  const product =
    (typeof l?.product === "string" ? l.product : null) ||
    l?.product?.longCategoryName ||
    l?.product?.shortCategoryName ||
    l?.product?.categoryName ||
    "Trein";

  return { dep, arr, originName, destName, originCode, destCode, depTrack, arrTrack, delayMin, product };
}

function computeTransfersFromLegs(legs){
  const transfers = [];
  let minTransferMin = null;

  if (!Array.isArray(legs) || legs.length < 2) return { transfers, minTransferMin };

  const nlegs = legs.map(normLeg);
  for (let i=0; i<nlegs.length-1; i++){
    const a = nlegs[i];
    const b = nlegs[i+1];
    if (!a.arr || !b.dep) continue;

    const aT = Date.parse(a.arr);
    const bT = Date.parse(b.dep);
    if (!isFinite(aT) || !isFinite(bT)) continue;

    const m = Math.round((bT - aT)/60000);
    const station = a.destName || "Overstap";
    if (m < 0) continue;

    transfers.push({ station, minutes: m });
    if (minTransferMin === null || m < minTransferMin) minTransferMin = m;
  }
  return { transfers, minTransferMin };
}

function sortByStartTime(arr){
  return arr.sort((a,b)=> (+new Date(a.depart)) - (+new Date(b.depart)));
}

/* state keys */
const LS = { van:"last_van", naar:"last_naar" };

/* elements */
const vanInput = document.getElementById("van");
const naarInput = document.getElementById("naar");
const stationsVan = document.getElementById("stationsVan");
const stationsNaar = document.getElementById("stationsNaar");
const dateInput = document.getElementById("dateInput");
const hourSelect = document.getElementById("hourSelect");
const minuteSelect = document.getElementById("minuteSelect");
const wisselBtn = document.getElementById("wisselBtn");
const zoekBtn = document.getElementById("zoekBtn");
const favBtn = document.getElementById("favBtn");
const favDiv = document.getElementById("favorieten");
const resultaat = document.getElementById("resultaat");
const humanErrorEl = document.getElementById("humanError");

/* keyboard weg (mobile) */
function dismissKeyboard(){ document.activeElement?.blur?.(); }
document.addEventListener("touchstart", (e) => {
  const t = e.target;
  if (t && (t.tagName === "INPUT" || t.tagName === "SELECT" || t.tagName === "TEXTAREA" || t.closest?.("button"))) return;
  dismissKeyboard();
}, { passive:true });
document.addEventListener("click", (e) => {
  const t = e.target;
  if (t && (t.tagName === "INPUT" || t.tagName === "SELECT" || t.tagName === "TEXTAREA" || t.closest?.("button"))) return;
  dismissKeyboard();
});

/* date picker */
dateInput.addEventListener("click", ()=>{
  if (dateInput.showPicker) dateInput.showPicker();
  else dateInput.focus();
});

/* time selects */
for(let h=0; h<24; h++){
  const o=document.createElement("option");
  o.value=pad2(h); o.textContent=pad2(h);
  hourSelect.appendChild(o);
}
for(let m=0; m<60; m+=5){
  const o=document.createElement("option");
  o.value=pad2(m); o.textContent=pad2(m);
  minuteSelect.appendChild(o);
}

/* load saved inputs */
vanInput.value = localStorage.getItem(LS.van) || "";
naarInput.value = localStorage.getItem(LS.naar) || "";

/* start time = now */
const now = roundTo5Min(new Date());
dateInput.value = localISODate(now);
hourSelect.value = pad2(now.getHours());
minuteSelect.value = pad2(now.getMinutes());

function persistStations(){
  localStorage.setItem(LS.van, vanInput.value);
  localStorage.setItem(LS.naar, naarInput.value);
}
["input","change"].forEach(evt=>{
  vanInput.addEventListener(evt, persistStations);
  naarInput.addEventListener(evt, persistStations);
});

function clearOnClick(el, key){
  el.addEventListener("click", ()=>{
    if (el.value.trim()) {
      el.value = "";
      localStorage.setItem(key,"");
    }
  });
}
clearOnClick(vanInput, LS.van);
clearOnClick(naarInput, LS.naar);

/* autocomplete */
let vanList = [];
let naarList = [];

const stationCache = new Map();
let stationAbortVan = null;
let stationAbortNaar = null;

async function loadStations(q, listEl, store, which){
  const query = (q || "").trim();
  if (query.length < 1) return;

  const key = query.toLowerCase();
  if (stationCache.has(key)){
    const data = stationCache.get(key) || [];
    listEl.innerHTML = "";
    store.length = 0;
    data.forEach(s=>{
      const opt=document.createElement("option");
      opt.value = s.namen.lang;
      listEl.appendChild(opt);
      store.push(s);
    });
    return;
  }

  if (which === "van"){
    if (stationAbortVan) stationAbortVan.abort();
    stationAbortVan = new AbortController();
  } else {
    if (stationAbortNaar) stationAbortNaar.abort();
    stationAbortNaar = new AbortController();
  }
  const signal = (which === "van") ? stationAbortVan.signal : stationAbortNaar.signal;

  const data = await fetchJson(`/stations?q=${encodeURIComponent(query)}`, { signal });
  stationCache.set(key, data || []);

  listEl.innerHTML = "";
  store.length = 0;
  (data||[]).forEach(s=>{
    const opt=document.createElement("option");
    opt.value = s.namen.lang;
    listEl.appendChild(opt);
    store.push(s);
  });
}

vanInput.addEventListener("input", debounce(()=>loadStations(vanInput.value, stationsVan, vanList, "van"), 200));
naarInput.addEventListener("input", debounce(()=>loadStations(naarInput.value, stationsNaar, naarList, "naar"), 200));

async function resolveCode(name, store){
  const wanted = normName(name);

  const hit = store.find(s=> normName(s.namen.lang) === wanted);
  if (hit) return hit.code;

  for (const arr of stationCache.values()){
    const ex = (arr||[]).find(s=> normName(s.namen.lang) === wanted);
    if (ex) return ex.code;
  }

  const data = await fetchJson(`/stations?q=${encodeURIComponent(name)}`);
  const exact = (data||[]).find(s=> normName(s.namen.lang) === wanted);
  return exact ? exact.code : null;
}

function buildDateTime(){
  return `${dateInput.value}T${hourSelect.value}:${minuteSelect.value}`;
}

/* =========================
   Inline OV (v1.07)
   ========================= */
const OV_STATIONS = new Set(["ddr","ddzd","rtb","rtd","gvh","gvc"]);
const OV_NAME_TO_CODE = new Map([
  ["dordrecht", "ddr"],
  ["dordrecht zuid", "ddzd"],
  ["rotterdam blaak", "rtb"],
  ["rotterdam centraal", "rtd"],
  ["den haag hs", "gvh"],
  ["den haag centraal", "gvc"],
]);

function iconForType(t){
  const x = String(t || "").toUpperCase();
  if (x.includes("METRO")) return "üöá";
  if (x.includes("TRAM")) return "üöã";
  return "üöå";
}
function fmtHHMM(iso){
  const d = new Date(iso);
  if (isNaN(d.getTime())) return "‚Äî";
  return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
}

function renderInlineDepartures(panelEl, title, data){
  panelEl.innerHTML = "";

  const head = document.createElement("div");
  head.style.fontWeight = "900";
  head.textContent = title;
  panelEl.appendChild(head);

  const deps = data?.departures || [];
  if (!deps.length){
    const dbg = (data?.perStop || [])
      .map(x => `${x.tpc} (${x.stopName || "?"}) passes=${x.passCount}`)
      .join(" ‚Ä¢ ");

    const msg = document.createElement("div");
    msg.className = "small";
    msg.style.marginTop = "6px";
    msg.innerHTML = `Geen live vertrektijden gevonden (of tijdelijk niet beschikbaar).<br><span style="opacity:0.9;">Debug: ${dbg || "‚Äî"}</span>`;
    panelEl.appendChild(msg);
    return;
  }

  deps.slice(0, 10).forEach(d => {
    const row = document.createElement("div");
    row.className = "ovItem";

    const left = document.createElement("div");
    left.className = "ovLeft";
    left.textContent = `${iconForType(d.transportType)} ${d.line || ""}`.trim();

    const mid = document.createElement("div");
    mid.className = "ovMid";
    mid.textContent = d.destination || d.stopName || "";

    const right = document.createElement("div");
    right.className = "ovRight";
    right.textContent = fmtHHMM(d.expectedTime);

    if (Number(d.delayMin) > 0){
      const s = document.createElement("span");
      s.className = "ovDelay";
      s.textContent = `+${d.delayMin}`;
      right.appendChild(s);
    }

    row.appendChild(left);
    row.appendChild(mid);
    row.appendChild(right);
    panelEl.appendChild(row);
  });
}

async function loadOvIntoPanel(panelEl, stationCode, label){
  panelEl.innerHTML = `<div class="small">Laden‚Ä¶</div>`;
  try{
    const data = await fetchJson(`/ov/by-station?station=${encodeURIComponent(stationCode)}`);
    renderInlineDepartures(panelEl, label, data);
  } catch(e){
    panelEl.innerHTML = `<div class="small">${humanizeError(e)}</div>`;
  }
}

/* Render expandable trip card */
function renderExpandableTrip(opt){
  const card = document.createElement("div");
  card.className = "resultCard";

  const legs = opt.legs || [];
  const transfersCount = Math.max(0, legs.length - 1);

  const transfersInfo = opt.transfersInfo || computeTransfersFromLegs(legs);
  const transfers = transfersInfo.transfers || [];
  const minTransferMin = transfersInfo.minTransferMin ?? null;
  const minCls = transferClass(minTransferMin);

  const header = document.createElement("div");
  header.className = "resultHeader";
  header.innerHTML = `
    <div class="resultHeaderLeft">
      <div class="tripTitle">Totale reistijd: ${opt.durationMin} min</div>
      <div class="timeBig"><span>${fmtTime(opt.depart)}</span> ‚Üí <span>${fmtTime(opt.arrive)}</span></div>
      <div class="badgeRow">
        <span class="badge">Overstappen: ${transfersCount}</span>
        ${minTransferMin !== null ? `<span class="badge ${minCls}">Min overstap: ${minTransferMin} min</span>` : ""}
      </div>
    </div>
    <div class="chev">‚ñæ</div>
  `;

  const details = document.createElement("div");
  details.className = "details";

  let built = false;

  function buildDetails(){
    if (built) return;
    built = true;

    if (minTransferMin !== null && minTransferMin < 3) {
      const w = document.createElement("div");
      w.className = "warn";
      w.textContent = `‚ö†Ô∏è Korte overstaptijd: minimaal ${minTransferMin} minuten.`;
      details.appendChild(w);
    }

    if (transfers.length){
      const tl = document.createElement("div");
      tl.className = "transferList";
      tl.innerHTML = `<b>Overstappen</b>`;
      transfers.forEach(t=>{
        const item = document.createElement("div");
        item.className = "transferItem";
        item.innerHTML = `
          <div class="transferLeft">${t.station}</div>
          <div class="transferRight ${transferClass(t.minutes)}">${t.minutes} min</div>
        `;
        tl.appendChild(item);
      });
      details.appendChild(tl);
    }

    details.appendChild(Object.assign(document.createElement("div"), { className:"hr" }));

    // per trip: onthoud welke ovPanel open is, zodat we kunnen sluiten
    let openPanel = null;

    legs.forEach((l, idx)=>{
      const x = normLeg(l);

      const originCode = (String(x.originCode||"").trim().toLowerCase()) || (OV_NAME_TO_CODE.get(normName(x.originName)) || "");
      const destCode   = (String(x.destCode||"").trim().toLowerCase())   || (OV_NAME_TO_CODE.get(normName(x.destName)) || "");

      const showOriginBtn = originCode && OV_STATIONS.has(originCode);
      const showDestBtn   = destCode && OV_STATIONS.has(destCode);

      const legEl = document.createElement("div");
      legEl.className = "leg";

      const line = document.createElement("div");
      line.className = "legLine";
      line.innerHTML = `
        <span>${x.originName || "‚Äî"} (spoor ${x.depTrack ?? "?"})</span>
        ${showOriginBtn ? `<button class="ovInlineBtn" data-ov="${originCode}" data-label="${x.originName||originCode}">OV</button>` : ""}
        ‚Üí
        <span>${x.destName || "‚Äî"} (spoor ${x.arrTrack ?? "?"})</span>
        ${showDestBtn ? `<button class="ovInlineBtn" data-ov="${destCode}" data-label="${x.destName||destCode}">OV</button>` : ""}
        ${x.delayMin > 0 ? `<span class="delay"> +${x.delayMin} min</span>` : ""}
      `;

      const top = document.createElement("div");
      top.className = "legTop";
      top.innerHTML = `
        <div>üöÜ ${x.product}</div>
        <div>${fmtTime(x.dep)} ‚Üí ${fmtTime(x.arr)}</div>
      `;

      // panel onder de regel
      const panel = document.createElement("div");
      panel.className = "ovPanel";
      panel.style.display = "none";

      legEl.appendChild(top);
      legEl.appendChild(line);
      legEl.appendChild(panel);

      // click handlers
      line.querySelectorAll("button.ovInlineBtn").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          e.stopPropagation();
          const code = btn.getAttribute("data-ov");
          const label = btn.getAttribute("data-label") || code;

          if (!code) return;

          const isOpen = panel.style.display !== "none";

          // sluit eventueel open panel (in deze trip)
          if (openPanel && openPanel !== panel){
            openPanel.style.display = "none";
            openPanel.innerHTML = "";
          }

          if (isOpen){
            panel.style.display = "none";
            panel.innerHTML = "";
            openPanel = null;
            return;
          }

          panel.style.display = "block";
          openPanel = panel;

          await loadOvIntoPanel(panel, code, `Live OV bij ${label}`);
        });
      });

      details.appendChild(legEl);

      if (idx < legs.length - 1) {
        details.appendChild(Object.assign(document.createElement("div"), { className:"hr" }));
      }
    });
  }

  header.addEventListener("click", ()=>{
    const willOpen = !details.classList.contains("open");
    if (willOpen) buildDetails();
    const isOpen = details.classList.toggle("open");
    header.querySelector(".chev").textContent = isOpen ? "‚ñ¥" : "‚ñæ";
  });

  card.appendChild(header);
  card.appendChild(details);
  return card;
}

/* Search (altijd Extreem-B) */
let inFlightSearch = null;

async function zoekReis(){
  humanErrorEl.textContent = "";
  resultaat.innerHTML = "";

  if (vanInput.value.trim().toLowerCase() === naarInput.value.trim().toLowerCase()) {
    humanErrorEl.textContent = "‚ö†Ô∏è Je hebt hetzelfde station gekozen bij vertrek en aankomst.";
    return;
  }

  if (inFlightSearch) inFlightSearch.abort();
  inFlightSearch = new AbortController();
  const signal = inFlightSearch.signal;

  try{
    const vanName = vanInput.value.trim();
    const naarName = naarInput.value.trim();
    const dt = buildDateTime();

    if (!vanName || !naarName) return alert("Vul van en naar in.");
    if (!dt) return alert("Kies datum/tijd.");

    zoekBtn.disabled = true;
    zoekBtn.textContent = "Zoeken‚Ä¶";

    const [vanCode, naarCode] = await Promise.all([
      resolveCode(vanName, vanList),
      resolveCode(naarName, naarList)
    ]);

    if (!vanCode || !naarCode) return alert("Kies stations uit de lijst (klik op een suggestie).");

    const data = await fetchJson(
      `/reis-extreme-b?van=${encodeURIComponent(vanCode)}&naar=${encodeURIComponent(naarCode)}&datetime=${encodeURIComponent(dt)}`,
      { signal }
    );

    const opts = Array.isArray(data.options) ? data.options : [];
    if (!opts.length) {
      resultaat.innerHTML = `<div class="resultCard">Geen opties gevonden.</div>`;
      return;
    }

    opts.forEach(o=>{
      o.transfersInfo = o.transfersInfo || computeTransfersFromLegs(o.legs || []);
    });

    const frag = document.createDocumentFragment();
    sortByStartTime(opts).forEach(o=>{
      frag.appendChild(renderExpandableTrip(o));
    });
    resultaat.appendChild(frag);

  } catch(e){
    const msg = humanizeError(e);
    if (msg) {
      humanErrorEl.textContent = msg;
      resultaat.innerHTML = `<div class="resultCard">${msg}</div>`;
    }
  } finally{
    zoekBtn.disabled = false;
    zoekBtn.textContent = "Zoek reis";
  }
}

/* Enter = zoeken */
[vanInput, naarInput, dateInput, hourSelect, minuteSelect].forEach(el=>{
  el.addEventListener("keydown",(e)=>{
    if (e.key==="Enter"){ e.preventDefault(); zoekReis(); }
  });
});
zoekBtn.addEventListener("click", zoekReis);

/* Wissel */
wisselBtn.addEventListener("click", ()=>{
  const t = vanInput.value;
  vanInput.value = naarInput.value;
  naarInput.value = t;
  persistStations();
});

/* FAVORIETE REIZEN (LOCALSTORAGE) */
const FAV_KEY = "planner_favorieten_v1";
const norm = (s) => String(s || "").trim().replace(/\s+/g, " ").toLowerCase();

function getFavs() {
  try {
    const raw = localStorage.getItem(FAV_KEY);
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? parsed : [];
  } catch {
    return [];
  }
}
function saveFavs(favs) {
  localStorage.setItem(FAV_KEY, JSON.stringify(favs));
}
function laadFavorieten() {
  const favs = getFavs();
  favDiv.innerHTML = "";

  if (!favs.length) {
    favDiv.innerHTML = `<div class="small">Nog geen favoriete reizen.</div>`;
    return;
  }

  const frag = document.createDocumentFragment();

  favs.forEach((f, i) => {
    const row = document.createElement("div");
    row.className = "favitem";

    const label = document.createElement("span");
    label.textContent = `${f.van} ‚Üí ${f.naar}`;

    const del = document.createElement("button");
    del.className = "favDel";
    del.type = "button";
    del.textContent = "‚úñ";

    label.onclick = () => {
      vanInput.value = f.van;
      naarInput.value = f.naar;
      persistStations();
      dismissKeyboard();
      window.scrollTo({ top: 0, behavior: "smooth" });
    };

    del.onclick = () => {
      const updated = favs.slice();
      updated.splice(i, 1);
      saveFavs(updated);
      laadFavorieten();
    };

    row.appendChild(label);
    row.appendChild(del);
    frag.appendChild(row);
  });

  favDiv.appendChild(frag);
}

favBtn.addEventListener("click", () => {
  const van = vanInput.value.trim();
  const naar = naarInput.value.trim();
  if (!van || !naar) return alert("Vul van en naar in.");

  const favs = getFavs();
  const exists = favs.some((f) => norm(f.van) === norm(van) && norm(f.naar) === norm(naar));
  if (exists) return alert("Deze favoriete reis bestaat al.");

  favs.push({ van, naar });
  saveFavs(favs);
  laadFavorieten();

  const old = favBtn.textContent;
  favBtn.textContent = "‚úÖ Opgeslagen";
  setTimeout(() => (favBtn.textContent = old), 900);
});

laadFavorieten();

/* PWA */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sw.js");
}
</script>
</body>
</html>